---
layout: post
title: Installing and automating ClamAV on macOS
meta: Running through the process of installing and setting up ClamAV anti-virus scanner, then automating and logging regular scans.
category: software
tags: [macOS, anti-virus]
---
<h3 class="page.title">
  {% if page.title %}
      <a href="{{ site.baseurl }}{{ page.url }}">{{ page.title }}</a>
  {% endif %}
</h3>

**{{ page.date | date_to_long_string }}**

___
#### What's going down
[ClamAV](https://www.clamav.net/) is anti-virus software developed by Cisco.
It runs on macOS, the BSDs, Linux, Windows etc.

Even though you're obviously exercising caution in your daily computing, sometimes it's worth scanning for software to see if you've picked up any malware, even if it hasn't been able to affect you.

All of the ClamAV setup can be found in the [manual](https://github.com/vrtadmin/clamav-faq/raw/master/manual/clamdoc.pdf).

Throughout, the macOS directory `Users` can be substituted by `home` on BSD or Linux.

##### Manual
To view the manual at any time, just `man clamscan` or use the link above.

##### Install
Installation is easier with [Homebrew](https://www.brew.sh).

    brew install clamav

##### Create and edit configuration files

```sh
    cd /usr/local/etc/clamav
    cp freshclam.conf.sample freshclam.conf
    vi freshclam.conf

    # Comment/Uncomment the following lines:
    # Example
    SubmitDetectionStats /var/logs/clamav
```
##### Update database

    freshclam

If the output is OK, create a log file in /var/log (owned by clamav or another user freshclam will be running as):

```sh
    touch /var/log/freshclam.log
    chmod 600 /var/log/freshclam.log
    chown clamav /var/log/freshclam.log
```
Then run the following to start the freshclam daemon:

```sh
freshclam -d
```

##### Scanning
Running a full system scan uses the familiar layout of `command flags target`, flags -r is recursive, --bell shows a Terminal bell when an infection is found and -i will only print the infected files.

```sh
clamscan -r --bell -i /
```
The output will show you any infected files, with their locations.

Other options are available, such as the flag `--move=/Users/[username]/quarantine` which moves viruses to a specified location.

##### Dealing with infections
When an infection is found, the options depend on which flags you used previously.
ClamAV's `--remove` flag should remove any infections during the scan.
This can be dangerous (and even carries a warning in the manual) as it can/will remove files that an infection is part of.
It re-runs the scan and deals with the infections as it finds them.

```sh
clamscan -r --remove /Users/[username]
```

Alternatively, if you used the `--move` flag then you could go straight to the specified folder and remove them manually.
Lastly, you can just read the locations from the output.

##### Automatic daily scans
The next thing to do is make sure all this automated so it runs in the background without input.
This part is courtest of [centosblog](https://www.centosblog.com/how-to-install-clamav-and-configure-daily-scanning-on-centos/).

```sh
vi ~/scripts/ClamAV
    SCAN_DIR="/Users"
    LOG_FILE="/var/log/clamscan.log"
    echo `date +%F-%H%M` >> $LOG_FILE
    /usr/local/bin/clamscan -i -r --move=/Users/[username]/quarantine $SCAN_DIR >> $LOG_FILE
    # on BSD/Linux the location might be /usr/bin, so:
    /usr/bin/clamscan -i -r --move=/Users/[username]/quarantine $SCAN_DIR >> $LOG_FILE
```
The script needs to be executable:

```sh
chmod u+x ~/scripts/ClamAV
```
Finally, since we told it to write a logfile in `/var/log` we need to make it can be written, so create the file and set the permissions on it to match the user who will be running the script:

```sh
sudo touch /var/log/clamscan.log
sudo chown [username]:[group] /var/log/clamscan.log
```

Now we just need to install it to crontab and make sure it runs regularly:

```sh
crontab -e
05	*	*	*	*	~/scripts/ClamAV
```

#### Sources
* [ClamAV](https://www.clamav.net/)
* [centosblog](https://www.centosblog.com/how-to-install-clamav-and-configure-daily-scanning-on-centos/)
* [AskUbuntu](https://askubuntu.com/questions/250290/how-do-i-scan-for-viruses-with-clamav)
